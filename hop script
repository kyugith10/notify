if not game:IsLoaded() then game.Loaded:Wait() end
repeat task.wait() until game:GetService("Players").LocalPlayer

local Workspace = game:GetService("Workspace")
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local Player = Players.LocalPlayer

--WEBHOOKS
local WEBHOOKS = {
    ["1-9m"]   = "https://discord.com/api/webhooks/1439927371254730772/YW7oHz0a7XKVRqpn8BT6wjzwI0TFOBhQNxKpR9nBwOO4oqm_AtetdlTRHjx84zWqKFs2",
    ["10-49m"] = "https://discord.com/api/webhooks/1439927583180455969/yL6mKQM2nu805cVEDgOGQxPV3ORZrHfjs1xMB8pqCdlqrjcmn78mVad7f1ovGUnd7guj",
    ["50-99m"] = "https://discord.com/api/webhooks/1439927807953338368/XSt1jSOAYN2xPqyTo8CQ1c7QsZbPUuKPksp-wm2_68NheUhEiaFWldwksTtsAg91hisM",
    ["100m+"]  = "https://discord.com/api/webhooks/1439928047364083833/URkD_pCS-eqfPRnpmaEroPOqWxBkdzkT0bosxEFiqpnPb4V8h42ZtskZsTSiH_VjRtG1"
}

-- CONFIG (ACTUALIZADO PARA CORE SERVER)
local SCAN_DURATION = 0.7
local SCAN_INTERVAL = 0.15      -- Optimizado
local MAX_HOP_ATTEMPTS = 99999

-- *** CAMBIAR ESTA URL A TU CORE SERVER ***
local CORE_SERVER_URL = "https://tu-core-server.up.railway.app"

local API_URL_GET = CORE_SERVER_URL .. "/get-server"
local API_URL_VISIT = CORE_SERVER_URL .. "/report-visit"
local API_URL_ADD = "https://hika.up.railway.app/forward"  -- Mantener para reportar hallazgos

local PLACE_ID = game.PlaceId

-- LOGGING
local function log(level, msg)
    print(string.format("[%s][%s] %s", os.date("%H:%M:%S"), string.upper(level), msg))
end

-- PARSE GENERATION
local function parseGeneration(genStr)
    if not genStr then return 0 end
    genStr = string.gsub(genStr, "[%$,/s]", "")
    genStr = string.upper(genStr)
    local number, suffix = string.match(genStr, "([%d%.]+)([KMB]?)")
    number = tonumber(number) or 0
    if suffix=="K" then number*=1e3
    elseif suffix=="M" then number*=1e6
    elseif suffix=="B" then number*=1e9 end
    return number
end

local function determineTier(value)
    if value >= 1e7 and value < 5e7 then return "10m"
    elseif value >= 5e7 and value < 1e8 then return "50m"
    elseif value >= 1e8 and value < 3e8 then return "100m"
    elseif value >= 3e8 then return "300m"
    else return nil end
end

-- ENV√çO A API (para reportar hallazgos)
local function SendToAPI(data)
    local req = http_request or request or (syn and syn.request) or (fluxus and fluxus.request)
    if not req then return end
    local body = HttpService:JSONEncode(data)
    req({
        Url = API_URL_ADD,
        Method = "POST",
        Headers = { ["Content-Type"]="application/json" },
        Body = body
    })
    log("info", "‚úì Enviado a API: " .. #data.brainrots .. " brainrots")
end

-- *** NUEVO: REPORTAR VISITA AL CORE SERVER ***
local function reportVisit(foundItems)
    spawn(function()
        local req = http_request or request or (syn and syn.request) or (fluxus and fluxus.request)
        if not req then 
            warn("[TRACKING] http_request no disponible")
            return 
        end
        
        local success, err = pcall(function()
            local resp = req({
                Url = API_URL_VISIT,
                Method = "POST",
                Headers = { ["Content-Type"]="application/json" },
                Body = HttpService:JSONEncode({
                    jobId = game.JobId,
                    found_items = foundItems
                })
            })
            if resp and resp.StatusCode == 200 then
                log("info", "‚úì Visita reportada al Core Server")
            end
        end)
        
        if not success then
            warn("[TRACKING] Error: " .. tostring(err))
        end
    end)
end

-- ESCANEO (MODIFICADO PARA RETORNAR TRUE/FALSE)
local function scanPlots()
    log("info", "üîç Escaneando plots...")
    local startTime = tick()
    local sent = {}
    local allBrainrots = {}

    while tick() - startTime < SCAN_DURATION do
        local plots = Workspace:FindFirstChild("Plots")
        if plots then
            for _, desc in ipairs(plots:GetDescendants()) do
                if desc.Name == "AnimalOverhead" then
                    local display = desc:FindFirstChild("DisplayName")
                    local generation = desc:FindFirstChild("Generation")
                    if display and generation and display:IsA("TextLabel") and generation:IsA("TextLabel") then
                        local name = display.Text ~= "" and display.Text or display.ContentText
                        local gen = generation.Text ~= "" and generation.Text or generation.ContentText
                        if name and gen and gen:find("/s") then
                            local key = name .. "_" .. gen
                            if not sent[key] then
                                sent[key] = true
                                local value = parseGeneration(gen)
                                local tier = determineTier(value)
                                if tier then
                                    table.insert(allBrainrots, {tier=tier, name=name, gen=gen, value=value})
                                end
                            end
                        end
                    end
                end
            end
        end
        task.wait(SCAN_INTERVAL)
    end

    if #allBrainrots > 0 then
        SendToAPI({
            jobId = game.JobId,
            players = #Players:GetPlayers(),
            brainrots = allBrainrots,
            timestamp = os.time()
        })
        return true  -- Encontr√≥ items
    else
        log("info", "‚ö†Ô∏è No se detectaron brainrots")
        return false  -- No encontr√≥ nada
    end
end

-- SERVER HOP (ACTUALIZADO PARA CORE SERVER)
local attempt = 0
local function GetJobId()
    local req = http_request or request or (syn and syn.request) or (fluxus and fluxus.request)
    if not req then 
        warn("[ERROR] http_request no disponible")
        return nil 
    end
    
    local success, resp = pcall(function()
        return req({
            Url = API_URL_GET, 
            Method = "GET",
            Headers = { ["Content-Type"] = "application/json" }
        })
    end)
    
    if not success then
        warn("[ERROR] Request fall√≥: " .. tostring(resp))
        return nil
    end
    
    if resp and resp.StatusCode == 200 and resp.Body then
        local ok, data = pcall(function() 
            return HttpService:JSONDecode(resp.Body) 
        end)
        
        if ok and data and data.job_id then 
            log("info", "‚úì JobID obtenido del Core Server")
            return data.job_id 
        end
    elseif resp and resp.StatusCode == 404 then
        warn("‚ö†Ô∏è Core Server sin servers disponibles (pool vac√≠o)")
    end
    
    return nil
end

local function Teleport_To_Server()
    attempt += 1
    if attempt > MAX_HOP_ATTEMPTS then
        log("error", "‚ùå M√°ximo de intentos alcanzado")
        return
    end
    
    log("info", "üåç Pidiendo servidor al Core... (Intento " .. attempt .. ")")
    local jobId = GetJobId()
    
    if jobId then
        log("info", "üöÄ Teletransportando al JobID: " .. jobId)
        local ok, err = pcall(function()
            TeleportService:TeleportToPlaceInstance(PLACE_ID, jobId, Player)
        end)
        
        if not ok then
            warn("[Error Teleport]: " .. tostring(err))
            task.wait(0.6)
            Teleport_To_Server()
        end
    else
        warn("‚ùå No se pudo obtener JobID del Core Server, reintentando...")
        task.wait(2)  -- Esperar un poco m√°s si el pool est√° vac√≠o
        Teleport_To_Server()
    end
end

TeleportService.TeleportInitFailed:Connect(function()
    warn("‚ö†Ô∏è Teleport fallido, reintentando...")
    task.wait(0.3)
    Teleport_To_Server()
end)

-- MAIN (ACTUALIZADO)
local function main()
    log("info", "ü§ñ Bot iniciado - Conectando a Core Server...")
    task.wait(0)
    
    local foundSomething = scanPlots()
    reportVisit(foundSomething)
    
    log("info", "‚úì Escaneo completado")
    Teleport_To_Server()
end

main()
